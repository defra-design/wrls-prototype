{% extends "layouts/_manage.html" %}

<!-- show the contact name, if there isn't one then show the email address instead -->
{% if data.contacts[data.contactID]['name'].length %}
{% set titleName = [data.contacts[data.contactID]['name']] %}
{% else %}
{% set titleName = [data.contacts[data.contactID]['email']] %}
{% endif %}
<!--set page title-->
{% set title = "Set up contact" %}
{% if data.edit == "true" %}
{% set title = "Edit contact" %}
{% endif %}


{% block breadcrumbs %}




{% endblock %}

{% block pageTitle %}
{{title}} - GOV.UK
{% endblock %}

<!--content block-->
{% block service %}

{% if data.changed == 1 %}

{{ govukNotificationBanner({
  text: "Contact details changed",
  type: "type"
}) }}

{% endif %}


<!-- page title -->
<div class="govuk-grid-row">
  <div class="govuk-grid-column-full govuk-!-margin-top-6">
    <h1 class="govuk-heading-l">
      <span class="govuk-caption-l">{{data.customers[data.customerID]['name']}}</span>
      {{title | safe}}
    </h1>
</div>
</div>

<div class="govuk-grid-row govuk-!-margin-bottom-6">
  <div class="govuk-grid-column-full">

    <!--set the action text to be add if there isn't an email address already there-->
    {% if [data.contacts[data.contactID].email] == "" %}
    {% set actionEmail = "Add" %}
    {% else %}
    {% set actionEmail = "Change" %}
    {% endif %}

    <!--set the action text to be add if there isn't a postal address already there-->
    {% if [data.contacts[data.contactID].post] == "" %}
    {% set actionPost = "Add" %}
    {% else %}
    {% set actionPost = "Change" %}
    {% endif %}

    <!--set the action text to be add if there isn't an phone number already there-->
    {% if [data.contacts[data.contactID].phone] == "" %}
    {% set actionPhone = "Add" %}
    {% else %}
    {% set actionPhone = "Change" %}
    {% endif %}

    <!--set the action text to be created in NALD if the contact wasn't created in WRLS-->
    {% set nameItem = [] %}
    {% if [data.contacts[data.contactID].wrls] == "true" %}
    {% set nameItem = nameItem | push (
    { href: "change-name?contactID=" + data.contactID,
      text: "Change",
     visuallyHiddenText: "name"}
    ) %}
    {% else %}
    {% set nameItem = nameItem | push (
    {
      html: '<span class="govuk-body">Created in NALD</span>',
      classes: "govuk-link--no-underline"
    }
    ) %}
    {% endif %}

<h2 class="govuk-heading-m govuk-!-margin-bottom-0">Contact details</h2>

      {{ govukSummaryList({
  rows: [
  {
    key: {
      text: "Name"
    },
    value: {
      text: data.contacts[data.contactID].name
    },
    actions: {
      items: nameItem
    }
  },
    {
      key: {
        text: "Email address"
      },
      value: {
        text: data.contacts[data.contactID].email
      },
      actions: {
        items: [
          {
            href: "change-email-address",
            text: actionEmail,
            visuallyHiddenText: "email address"
          }
        ]
      }
    },
      {
        key: {
          text: "Postal address"
        },
        value: {
          text: data.contacts[data.contactID].post
        },
        actions: {
          items: [
            {
              href: "change-postal-address",
              text: actionPost,
              visuallyHiddenText: "postal address"
            }
          ]
        }
      },
      {
        key: {
          text: "Phone number"
        },
        value: {
          text: data.contacts[data.contactID].phone
        },
        actions: {
          items: [
            {
              href: "change-phone-number",
              text: actionPhone,
              visuallyHiddenText: "phone number"
            }
          ]
        }
      }
  ]
}) }}

</div></div>

<div class="govuk-grid-row govuk-!-margin-bottom-6">
  <div class="govuk-grid-column-full">

<h2 class="govuk-heading-m govuk-!-margin-bottom-0">Communication types</h2>

{% set waa = "No" %}
{% set returns = "No" %}
{% set detailsWaa = "" %}
{% set detailsReturns = "" %}
{% for item in data.contacts[data.contactID].customers %}
  {% if item.customer == data.customers[data.customerID].name %}
    {% for i in item.notices %}

      {% if i.type == "Water abstraction alerts" or i.type == "water abstraction alerts"%}
     
        {% if i.sendBy == "email" %}
          {% if i.licences == "all"%}
          {% set waa = "Yes, for all licences" %}

          {% else %}
          {% set waa = "Yes, for some licences" %}
          {% set detailsWaa %}
          {% set licenceWaa = [] %}
          {% for i in i.licences %}

          {% set licenceWaa = licenceWaa | push (i)  %}
          {% endfor %}
                {{ govukDetails({
                  summaryText: "Licence details",
                  html: licenceWaa | dump | stripQuotes | stripSqBrackets | replaceComma | striptags(true) | escape | nl2br
                }) }}
          {% endset -%}
          {% endif %}
        {% endif %}

        {% elif i.type == "Returns" or i.type == "returns"%}
          {% if i.licences == "all"%}
          {% set returns = "Yes, for all licences" %}

          {% else %}
          {% set returns = "Yes, for some licences" %}
          {% set detailsReturns %}
          {% set licenceReturns = [] %}
          {% for i in i.licences %}

          {% set licenceReturns = licenceReturns | push (i)  %}
          {% endfor %}
              {{ govukDetails({
                summaryText: "Licence details",
                html: licenceReturns | dump | stripQuotes | stripSqBrackets | replaceComma | striptags(true) | escape | nl2br
              }) }}
          {% endset -%}
          {% endif %}

      {% endif %}
    {% endfor%}
  {% endif %}
{% endfor%}



      {{ govukSummaryList({
  rows: [
    {
      key: {
        text: "Water abstraction alerts"
      },
      value: {
        html: waa + detailsWaa
      },
      actions: {
        items: [
          {
            href: "notices?type=water%20abstraction%20alerts",
            text: "Change",
            visuallyHiddenText: "Water abstraction alerts"
          }
        ]
      }
    },
    {
      key: {
        text: "Returns invites and reminders"
      },
      value: {
        html: returns + detailsReturns
      },
      actions: {
        items: [
          {
            href: "notices?type=returns",
            text: "Change",
            visuallyHiddenText: "Returns invites and reminders"
          }
        ]
      }
    }
  ]
}) }}

</div>
</div>

    <form method="post" novalidate>
 <!--add a contact-->
    {{ govukButton({
    text: "Confirm",
    classes: "govuk-!-margin-right-3"
    }) }}


    <!--remove a contact-->
    {{ govukButton({
    text: "Cancel set up",
    href: "../cancel/check-your-answers",
    classes: "govuk-button--secondary"
    }) }}

</form>
{% endblock %}
