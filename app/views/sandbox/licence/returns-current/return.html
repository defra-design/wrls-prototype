{% extends "layouts/_manage.html" %}

<!--set page title-->


{% set title = "Abstraction return" %}




{% block pageTitle %}
{{title}} - GOV.UK
{% endblock %}



<!--content block-->
{% block service %}
<div class="govuk-grid-row">
  <div class="govuk-grid-column-full">

    <!-- page heading -->
    <h1 class="govuk-heading-xl govuk-!-margin-bottom-2"><span class="govuk-caption-l ">Licence {{data.licences[data.ID]['number']}}</span> {{title}}</h1>
  </div></div>
    <div class="govuk-grid-row govuk-!-margin-bottom-4">
      <div class="govuk-grid-column-full">
    {{govukTag({
      text: data.licences[data.ID].returns[data.returnIndex].status | returnStatusText | safe,
      classes: data.licences[data.ID].returns[data.returnIndex].status | returnStatusColour
      })}}
      </div></div>
      <div class="govuk-grid-row govuk-!-margin-bottom-8">
        <div class="govuk-grid-column-full">

{{ govukSummaryList({
classes: 'govuk-summary-list--no-border',
rows: [
  {
    key: {
      text: "Return reference",
      classes: "meta-data__label"
    },
    value: {
      text: data.licences[data.ID].returns[data.returnIndex].id,
      classes: "meta-data__value"
    }
  },
  {
    key: {
      text: "Site description",
      classes: "meta-data__label"
    },
    value: {
      text: data.licences[data.ID].returns[data.returnIndex].description,
      classes: "meta-data__value"
    }
  },
  {
    key: {
      text: "Purpose",
      classes: "meta-data__label"
    },
    value: {
      text: data.licences[data.ID].returns[data.returnIndex].purpose | dump | stripQuotes | stripSqBrackets | replaceComma | striptags(true) | escape | nl2br,
      classes: "meta-data__value"
    }
  },
  {
    key: {
      text: "Returns period",
      classes: "meta-data__label"
    },
    value: {
      text: "From " + data.licences[data.ID].returns[data.returnIndex].returnsPeriodStart | numberToGovukDate + " to " + data.licences[data.ID].returns[data.returnIndex].returnsPeriodEnd | numberToGovukDate,
      classes: "meta-data__value"
    }
  },
  {
    key: {
      text: "Abstraction period",
      classes: "meta-data__label"
    },
    value: {
      text: "From " + data.licences[data.ID].returns[data.returnIndex].periodStart | mmddToDate + " to " + data.licences[data.ID].returns[data.returnIndex].periodEnd | mmddToDate,
      classes: "meta-data__value"
    }
  },
  {
    key: {
      text: "Standard tariff",
      classes: "meta-data__label"
    }
  }
]
}) }}
<a href="../../licence#returns">View licence</a>
</div>
</div>




{% if data.licences[data.ID].returns[data.returnIndex].versions.length and data.edit !== "true" %}
<div class="govuk-grid-row govuk-!-margin-bottom-8">
  <div class="govuk-grid-column-full">
    {% if data.licences[data.ID].returns[data.returnIndex].versions[0].nilReturn == true %}
    <h2 class="govuk-heading-l">Nil return</h2>
    {{ govukButton({
      text: "Edit return",
      href: "?edit=true#"
    }) }}
    {% else %}
    <h2 class="govuk-heading-l"><span class="govuk-body govuk-!-font-size-80 govuk-!-font-weight-bold">{{data.licences[data.ID].returns[data.returnIndex].versions[0].lines | sumVolumes | toGovNumber}} </span><span class="govuk-body govuk-!-font-weight-bold govuk-body govuk-!-font-size-24">cubic metres</span></span><br>
      <span class="govuk-body govuk-!-font-weight-bold govuk-body govuk-!-font-size-24">Total amount of water abstracted</span></h2>
    {{ govukButton({
      text: "Edit return",
      href: "?edit=true#"
    }) }}


    <!--divider-->
    <div class="divider govuk-!-margin-bottom-7"></div>
   
    <!--heading for table based on readings or volumes incorporating frequency from the return-->
   {% if data.licences[data.ID].returns[data.returnIndex].versions[0].readingsOrVolumes == "readings" %}
    <h3 class="govuk-heading-l">Summary of {{data.licences[data.ID].returns[data.returnIndex].frequency }} meter readings</h3>
   {% else %}
    <h3 class="govuk-heading-l">Summary of {{data.licences[data.ID].returns[data.returnIndex].frequency }} abstraction volumes</h3>
    {% endif %}


    <!--meter details if needed-->
    {% if data.licences[data.ID].returns[data.returnIndex].versions[0].meterDetails | objLength !== 0 %}
    {% set meterDetails = data.licences[data.ID].returns[data.returnIndex].versions[0].meterDetails %}

    {% set meterDetailsMetaData %}
    {{ govukSummaryList({
      classes: 'govuk-summary-list--no-border',
      rows: [
        {
          key: {
            text: "Meter type",
            classes: "meta-data__label"
          },
          value: {
            text: meterDetails.make,
            classes: "meta-data__value"
          }
        },
        {
          key: {
            text: "Meter number",
            classes: "meta-data__label"
          },
          value: {
            text: meterDetails.serialNumber,
            classes: "meta-data__value"
          }
        }
        ]
      })
    }}
    {% endset %}


    {{ govukButton({
      text: "Download this return",
      href: "/public/files/uploads/return772318.csv",
      classes: "govuk-button--secondary"
    }) }}

    {{ govukDetails({
      summaryText: "Meter details",
      html: meterDetailsMetaData
    }) }}
    {% endif %}
    
   

   {% include "sandbox/_includes/returns/submission/returns-table-monthly-summary.html" %}

    
    {% endif %}
    
    <h3 class="govuk-heading-m">Submitted by</h3>
   
      {% for version in data.licences[data.ID].returns[data.returnIndex].versions %}
      {% set loopIndex = loop.index0 %}
      {% if loopIndex == "0" %}
      {{ govukInsetText({
        html: data.licences[data.ID].returns[data.returnIndex].versions[loop.index0].submittedBy + "<br>" + data.licences[data.ID].returns[data.returnIndex].versions[loop.index0].submittedDate | formatDate,
        classes: "govuk-inset-text-blue"
      }) }}
      {% else %}
      {{ govukInsetText({
        html: data.licences[data.ID].returns[data.returnIndex].versions[loop.index0].submittedBy + "<br>" + data.licences[data.ID].returns[data.returnIndex].versions[loop.index0].submittedDate | formatDate
      }) }}
      {% endif %}
      {% endfor %}

</div>
</div>
{% endif %}

{% if (data.licences[data.ID].returns[data.returnIndex].status == "due") or (data.licences[data.ID].returns[data.returnIndex].status == "open") or (data.licences[data.ID].returns[data.returnIndex].status == "overdue") or (data.licences[data.ID].returns[data.returnIndex].status == "received") or data.edit == "true" %}


<div class="govuk-grid-row govuk-!-margin-bottom-8">
  <div class="govuk-grid-column-two-thirds">
      <form action="submission/returnStatus" id="return-status"   data-routing="1" method="post" class="form">

          {{ govukRadios({
            idPrefix: "returnStatus",
            name: "returnStatus",
            fieldset: {
              legend: {
                text: "What would you like to do with this return?",
                isPageHeading: false,
                classes: "govuk-fieldset__legend--l"
              }
            },
            items: [
              {
                value: "enter",
                text: "Enter and submit it"
              },
              {
                value: "nil",
                text: "Enter a nil return"
              },
              {
                value: "received",
                text: "Record receipt (and come back to it later)"
              },
              {
                divider: "or"
              },
              {
                value: "new",
                text: "Enter new volumes or readings"
              }
            ]
          })
        }}

        <button type="submit" class="govuk-button">
          Continue
        </button>

      </form>

    </div>
    </div>

{% endif %}




{% endblock %}
