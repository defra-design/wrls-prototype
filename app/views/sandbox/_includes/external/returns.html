{% set allRows = [] %}

{% set licences = data['licences'] %}
{% for i in licences %}
{% if i.holder == data.customers[data.customerID]['name'] %}
{% set loopNumber = loop.index0 %}
{% set licenceID = loop.index0 %}

<!--check for filtered results-->
   {% if data['filteredResults'].length %}
   {% set returns = data['filteredResults']  %}

   {% set type = 'filtered'  %}
   {% else %}
   {% set returns = data.licences[licenceID]['returns'] %}

    {% set type = 'not filtered'  %}
   {% endif %}





{% if returns !== 'empty' %}
{% set rows = []%}
{% set voidCount = 0 %}
{% for return in returns %}
{% set due = return.due | numberToGovukDate %}
{% set status %}
{{govukTag({
text: return.status | returnStatusText | safe,
classes: return.status | returnStatusColour
})}}
{% endset %}
{% set rows = rows | push ([{html: '<a href="licence/returns-current/return?returnIndex='+loop.index0+'&versionID=0&returnStatus='+data.licences[data.ID].returns[loop.index0].status+'">'+return.id+'</a><p class="govuk-body-s">From ' + return.returnsPeriodStart | numberToGovukDate + ' to ' + return.returnsPeriodEnd | numberToGovukDate +'</p>'},{html: return.purpose+'<p class="govuk-body-s">'+return.description+'</p>'},{text: due},{html: status}]) %}
{% endfor %}
{% else %}
{% set rows = []%}
{% set voidCount = 0 %}
{% endif %}

{% set allRows = allRows| push(rows) %}

{% endif %}
{% endfor %}



{{ govukTable({
caption: caption | safe,
captionClasses: "govuk-table__caption--s",
firstCellIsHeader: false,
head: [
  {
    text: "Return reference and dates"
  },
  {
    text: "Purpose and description"
  }
  ,
  {
    text: "Due"
  }
  ,
  {
    text: "Status"
  }
],
rows: allRows|flatten

}) }}




